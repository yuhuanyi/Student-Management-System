{% extends "layout.html" %}
<!-- 继承自 layout.html 模板，这样可以复用 layout.html 中的通用布局结构 -->

{% block content %}
<!-- 定义内容块，将在 layout.html 中对应的 content 块位置进行渲染 -->
<div class="visualization-container" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <!-- 可视化容器，设置内边距、最大宽度并居中显示 -->
    <h2 style="color: #2c3e50; text-align: center; margin: 30px 0; font-size: 1.8rem;">
        <i class="fas fa-chart-bar"></i> 校园数据分析
    </h2>
    <!-- 页面标题，显示校园数据分析，带有图标 -->

    <!-- 学生成绩分布箱线图（占据两个单位宽度） -->
    <div class="chart-row" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
        <!-- 图表行容器，使用 flex 布局，允许换行，设置间距和底部外边距 -->
        <div class="chart-card" style="flex: 2; min-width: 920px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <!-- 图表卡片，占据两个单位宽度，设置最小宽度、背景颜色、圆角、内边距和阴影 -->
            <h3 style="color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee;">学生成绩分布箱线图</h3>
            <!-- 图表标题 -->
            <div id="score-boxplot" style="height: 400px; width: 100%;"></div>
            <!-- 用于显示箱线图的容器 -->
        </div>
    </div>

    <!-- 原有图表行容器 -->
    <div class="chart-row" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
        <!-- 图表行容器，使用 flex 布局，允许换行，设置间距和底部外边距 -->
        <div class="chart-card" style="flex: 1; min-width: 450px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <!-- 图表卡片，占据一个单位宽度，设置最小宽度、背景颜色、圆角、内边距和阴影 -->
            <h3 style="color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eeeee;">
                成绩分布统计
                <select id="course-selector" style="float: right; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: -5px;">
                    <!-- 课程选择下拉框，用于选择不同课程的成绩分布 -->
                    <option value="all">所有课程</option>
                    <!-- 默认选项，显示所有课程的成绩分布 -->
                    {% for course in courses %}
                    <option value="{{ course.course_id }}">{{ course.course_name }}</option>
                    <!-- 循环生成每个课程的选项，值为课程 ID，显示课程名称 -->
                    {% endfor %}
                </select>
            </h3>
            <div id="score-distribution" style="height: 400px; width: 100%;"></div>
            <!-- 用于显示成绩分布柱状图的容器 -->
        </div>

        <div class="chart-card" style="flex: 1; min-width: 450px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <!-- 图表卡片，占据一个单位宽度，设置最小宽度、背景颜色、圆角、内边距和阴影 -->
            <h3 style="color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee;">专业平均分对比</h3>
            <!-- 图表标题 -->
            <div id="major-scores" style="height: 400px; width: 100%;"></div>
            <!-- 用于显示专业平均分雷达图的容器 -->
        </div>
    </div>

    <div class="chart-row" style="display: flex; flex-wrap: wrap; gap: 20px;">
        <!-- 图表行容器，使用 flex 布局，允许换行，设置间距 -->
        <div class="chart-card" style="flex: 1; min-width: 450px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <!-- 图表卡片，占据一个单位宽度，设置最小宽度、背景颜色、圆角、内边距和阴影 -->
            <h3 style="color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee;">课程平均分</h3>
            <!-- 图表标题 -->
            <div id="course-avgs" style="height: 400px; width: 100%;"></div>
            <!-- 用于显示课程平均分柱状图的容器 -->
        </div>

        <div class="chart-card" style="flex: 1; min-width: 450px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <!-- 图表卡片，占据一个单位宽度，设置最小宽度、背景颜色、圆角、内边距和阴影 -->
            <h3 style="color: #333; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee;">生源地分布</h3>
            <!-- 图表标题 -->
            <div id="hometown-distribution" style="height: 400px; width: 100%;"></div>
            <!-- 用于显示生源地分布饼图的容器 -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 定义脚本块，将在 layout.html 中对应的 scripts 块位置进行渲染 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 当文档加载完成后执行以下代码
        if (typeof echarts === 'undefined') {
            // 检查 ECharts 库是否加载
            console.error('ECharts未加载');
            alert('图表加载失败：ECharts库未找到');
            return;
        }

        // 1. 学生成绩分布箱线图 - 使用后端传递的真实数据
        const boxplotChart = echarts.init(document.getElementById('score-boxplot'));
        // 初始化箱线图图表实例

        boxplotChart.setOption({
            // 设置箱线图的配置选项
            title: {
                text: '各课程成绩分布对比',
                left: 'center',
                textStyle: {
                    color: '#333',
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    const data = params.data;
                    return `<div style="font-weight:bold">${params.name}</div>` +
                           `最小值: ${data[1].toFixed(1)}<br>` +  // 保留一位小数
                           `下四分位: ${data[2].toFixed(1)}<br>` +
                           `中位数: ${data[3].toFixed(1)}<br>` +
                           `上四分位: ${data[4].toFixed(1)}<br>` +
                           `最大值: ${data[5].toFixed(1)}`;
                },
                textStyle: {
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            grid: {
                left: '5%',
                right: '5%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: {{ course_names | tojson }},  // 使用后端传递的课程名称
                axisLabel: {
                    rotate: 30,
                    interval: 0,
                    color: '#666',
                    fontFamily: 'Microsoft YaHei, sans-serif',  // 添加中文字体支持
                    fontSize: 12
                },
            },
            yAxis: {
                type: 'value',
                min: 50,  // 更合理的范围
                max: 100,
                interval: 10,
                axisLabel: {
                    formatter: '{value} 分',
                    color: '#666',
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                },
                name: '成绩',
                nameLocation: 'middle',
                nameGap: 40,
                nameTextStyle: {
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            series: [{
                type: 'boxplot',
                data: {{ boxplot_data | tojson }},  // 使用后端传递的箱线图数据
                itemStyle: {
                    color: '#3498db',
                    borderWidth: 2
                },
                emphasis: {
                    itemStyle: {
                        color: '#e74c3c',
                        borderWidth: 3
                    }
                }
            }]
        });

        // 2. 成绩分布柱状图 - 增加课程选择功能
        const scoreChart = echarts.init(document.getElementById('score-distribution'));
        // 初始化成绩分布柱状图图表实例

        // 存储课程分布数据
        const courseDistributions = {
            'all': [
                {{ distribution['<60'] | default(0) }},
                {{ distribution['60-70'] | default(0) }},
                {{ distribution['70-80'] | default(0) }},
                {{ distribution['80-90'] | default(0) }},
                {{ distribution['90-100'] | default(0) }}
            ],
            {% for course in courses %}
            '{{ course.course_id }}': [
                {{ course_distributions[course.course_id]['<60'] | default(0) }},
                {{ course_distributions[course.course_id]['60-70'] | default(0) }},
                {{ course_distributions[course.course_id]['70-80'] | default(0) }},
                {{ course_distributions[course.course_id]['80-90'] | default(0) }},
                {{ course_distributions[course.course_id]['90-100'] | default(0) }}
            ]{% if not loop.last %},{% endif %}
            {% endfor %}
        };

        // 初始化图表
        function updateScoreDistributionChart(courseId = 'all') {
            // 根据选择的课程 ID 更新成绩分布柱状图
            const data = courseDistributions[courseId] || courseDistributions['all'];
            const selectedOption = document.getElementById('course-selector').options[document.getElementById('course-selector').selectedIndex];
            const courseName = selectedOption.text;
            const title = courseId === 'all' ? '所有课程成绩分布' : `"${courseName}" 成绩分布`;

            scoreChart.setOption({
                title: {
                    text: title,
                    left: 'center',
                    textStyle: {
                        fontFamily: 'Microsoft YaHei, sans-serif',
                        fontSize: 14
                    }
                },
                tooltip: { trigger: 'axis', formatter: '{b}分区间: {c}人' },
                xAxis: {
                    type: 'category',
                    data: ['<60', '60-70', '70-80', '80-90', '90-100'],
                    axisLabel: {
                        color: '#666',
                        fontFamily: 'Microsoft YaHei, sans-serif'
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '学生人数',
                    axisLabel: {
                        color: '#666',
                        fontFamily: 'Microsoft YaHei, sans-serif'
                    }
                },
                series: [{
                    name: '成绩分布',
                    type: 'bar',
                    data: data,
                    itemStyle: {
                        color: ['#ff4d4f', '#faad14', '#52c41a', '#1890ff', '#722ed1']
                    }
                }]
            });
        }

        // 初始显示所有课程分布
        updateScoreDistributionChart();

        // 监听课程选择变化
        document.getElementById('course-selector').addEventListener('change', function() {
            // 当课程选择发生变化时，更新成绩分布柱状图
            updateScoreDistributionChart(this.value);
        });

        // 3. 专业平均分雷达图 - 修复数据缺失问题
        const majorChart = echarts.init(document.getElementById('major-scores'));
        // 初始化专业平均分雷达图图表实例
        // 确保专业名称和分数数量一致
        const majorNames = {{ majors | tojson }};
        const majorScores = {{ major_scores | tojson }};

        // 动态创建指示器
        const radarIndicators = majorNames.map(name => ({
            name: name,
            max: 100
        }));

        majorChart.setOption({
            // 设置专业平均分雷达图的配置选项
            tooltip: { trigger: 'item' },
            radar: {
                indicator: radarIndicators,
                axisLine: { lineStyle: { color: '#666' } },
                splitLine: { lineStyle: { color: '#eee' } },
                splitNumber: 5,
                name: {
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            series: [{
                type: 'radar',
                data: [{
                    value: majorScores,
                    name: '专业平均分',
                    areaStyle: { color: 'rgba(25, 183, 255, 0.2)' },
                    lineStyle: { color: '#19b7ff', width: 2 },
                    itemStyle: { color: '#19b7ff' }
                }]
            }]
        });

        // 4. 课程平均分柱状图
        const courseChart = echarts.init(document.getElementById('course-avgs'));
        // 初始化课程平均分柱状图图表实例
        courseChart.setOption({
            // 设置课程平均分柱状图的配置选项
            tooltip: { trigger: 'axis', formatter: '{b}: {c}分' },
            xAxis: {
                type: 'category',
                data: {{ course_names | tojson }},  // 使用后端传递的课程名称
                axisLabel: {
                    rotate: 30,
                    interval: 0,
                    color: '#666',
                    fontFamily: 'Microsoft YaHei, sans-serif',  // 添加中文字体支持
                    fontSize: 12
                }
            },
            yAxis: {
                type: 'value',
                name: '平均分',
                min: 50,
                max: 100,
                axisLabel: {
                    color: '#666',
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                },
                nameTextStyle: {
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            series: [{
                name: '课程平均分',
                type: 'bar',
                data: {{ course_avgs | tojson }},
                itemStyle: {
                    color: function(params) {
                        const score = params.value;
                        return score < 60 ? '#ff4d4f' :
                               score < 70 ? '#faad14' :
                               score < 80 ? '#52c41a' :
                               score < 90 ? '#1890ff' : '#722ed1';
                    }
                }
            }]
        });

        // 5. 生源地分布饼图
        const hometownChart = echarts.init(document.getElementById('hometown-distribution'));
        // 初始化生源地分布饼图图表实例
        // 确保数据存在
        const hometownNames = {{ hometown_names | tojson }};
        const hometownCounts = {{ hometown_counts | tojson }};

        // 创建饼图数据
        const pieData = [];
        for (let i = 0; i < hometownNames.length; i++) {
            pieData.push({
                value: hometownCounts[i],
                name: hometownNames[i]
            });
        }

        // 如果没有数据，显示提示
        if (pieData.length === 0) {
            pieData.push({ value: 1, name: '暂无数据' });
        }

        hometownChart.setOption({
            // 设置生源地分布饼图的配置选项
            tooltip: { trigger: 'item', formatter: '{b}: {c}人 ({d}%)' },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                data: hometownNames,
                textStyle: {
                    color: '#666',
                    fontSize: 12,
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            },
            series: [{
                name: '生源地',
                type: 'pie',
                radius: '70%',
                center: ['40%', '50%'],
                data: pieData,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.3)',
                        borderWidth: 2,
                        borderColor: '#fff'
                    }
                },
                label: {
                    fontFamily: 'Microsoft YaHei, sans-serif'  // 添加中文字体支持
                }
            }]
        });

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            // 当窗口大小变化时，调整所有图表的大小
            boxplotChart.resize();
            scoreChart.resize();
            majorChart.resize();
            courseChart.resize();
            hometownChart.resize();
        });
    });
</script>
{% endblock %}